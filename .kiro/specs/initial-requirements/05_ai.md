# Phase 5: AI Integration (Kiro)

## Objective
Integrate Anthropic's Claude API to provide AI-assisted scripting, natural language element creation, smart suggestions, and automated content generation.

## Tasks

### 5.1 API Setup

**Environment Variables**

Add to `.env.local`:
```
ANTHROPIC_API_KEY=your_api_key_here
```

**Install Dependencies**
```bash
npm install @anthropic-ai/sdk
```

**API Service**: `lib/services/anthropic.ts`

```typescript
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
})

export interface AICompletionRequest {
  prompt: string
  systemPrompt?: string
  maxTokens?: number
}

export async function getAICompletion(request: AICompletionRequest): Promise<string> {
  const { prompt, systemPrompt, maxTokens = 1024 } = request

  const message = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: maxTokens,
    system: systemPrompt,
    messages: [
      {
        role: 'user',
        content: prompt,
      },
    ],
  })

  const textContent = message.content.find(block => block.type === 'text')
  return textContent ? textContent.text : ''
}

export async function streamAICompletion(
  request: AICompletionRequest,
  onChunk: (text: string) => void
): Promise<void> {
  const { prompt, systemPrompt, maxTokens = 1024 } = request

  const stream = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: maxTokens,
    system: systemPrompt,
    messages: [{ role: 'user', content: prompt }],
    stream: true,
  })

  for await (const event of stream) {
    if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') {
      onChunk(event.delta.text)
    }
  }
}
```

### 5.2 API Route for AI Completions

**API Route**: `app/api/ai/complete/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getAICompletion } from '@/lib/services/anthropic'
import { createServerClient } from '@/lib/supabase/server'

export async function POST(request: NextRequest) {
  try {
    // Verify authentication
    const supabase = createServerClient()
    const { data: { user } } = await supabase.auth.getUser()
    
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body = await request.json()
    const { prompt, systemPrompt, maxTokens } = body

    const completion = await getAICompletion({
      prompt,
      systemPrompt,
      maxTokens,
    })

    return NextResponse.json({ completion })
  } catch (error: any) {
    console.error('AI completion error:', error)
    return NextResponse.json(
      { error: error.message || 'Failed to get AI completion' },
      { status: 500 }
    )
  }
}
```

### 5.3 AI Script Generator

**Script Generator Service**: `lib/ai/script-generator.ts`

```typescript
const SCRIPT_GENERATION_SYSTEM_PROMPT = `You are an expert HyperCard script generator. Generate JavaScript code for HyperCard-style interactive elements.

Available API functions:
- goToNextCard() - Navigate to next card
- goToPrevCard() - Navigate to previous card
- goToCard(cardId) - Navigate to specific card
- updateElement(elementId, updates) - Update element properties
- showMessage(message) - Show alert dialog
- setVariable(key, value) - Store a variable
- getVariable(key) - Retrieve a variable
- hideElement(elementId) - Hide an element
- showElement(elementId) - Show an element
- playSound(url) - Play audio file

Generate clean, working JavaScript code without explanations unless requested.
Do not include markdown code blocks or formatting - just raw JavaScript code.`

export async function generateScript(description: string): Promise<string> {
  const response = await fetch('/api/ai/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: `Generate a HyperCard script for the following description:\n\n${description}`,
      systemPrompt: SCRIPT_GENERATION_SYSTEM_PROMPT,
      maxTokens: 512,
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to generate script')
  }

  const data = await response.json()
  return data.completion.trim()
}

export async function explainScript(script: string): Promise<string> {
  const response = await fetch('/api/ai/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: `Explain what this HyperCard script does in simple terms:\n\n${script}`,
      systemPrompt: 'You are a helpful programming tutor. Explain code clearly and concisely.',
      maxTokens: 256,
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to explain script')
  }

  const data = await response.json()
  return data.completion
}

export async function improveScript(script: string, goal: string): Promise<string> {
  const response = await fetch('/api/ai/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: `Improve this HyperCard script to ${goal}:\n\n${script}\n\nProvide only the improved code without explanations.`,
      systemPrompt: SCRIPT_GENERATION_SYSTEM_PROMPT,
      maxTokens: 512,
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to improve script')
  }

  const data = await response.json()
  return data.completion.trim()
}
```

### 5.4 AI-Powered Script Editor

**Enhanced Script Editor**: `components/editor/AIScriptEditor.tsx`

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { generateScript, explainScript, improveScript } from '@/lib/ai/script-generator'
import { Code, Sparkles, MessageSquare, Wand2, Loader2 } from 'lucide-react'

interface AIScriptEditorProps {
  script: string | null
  onSave: (script: string) => void
  onClose: () => void
  elementName?: string
}

export default function AIScriptEditor({ 
  script, 
  onSave, 
  onClose, 
  elementName 
}: AIScriptEditorProps) {
  const [code, setCode] = useState(script || '')
  const [aiPrompt, setAiPrompt] = useState('')
  const [loading, setLoading] = useState(false)
  const [explanation, setExplanation] = useState('')
  const [activeTab, setActiveTab] = useState<'editor' | 'ai' | 'explain'>('ai')

  const handleGenerate = async () => {
    if (!aiPrompt.trim()) return

    setLoading(true)
    try {
      const generatedCode = await generateScript(aiPrompt)
      setCode(generatedCode)
      setActiveTab('editor')
    } catch (error) {
      alert('Failed to generate script. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const handleExplain = async () => {
    if (!code.trim()) return

    setLoading(true)
    try {
      const explanation = await explainScript(code)
      setExplanation(explanation)
      setActiveTab('explain')
    } catch (error) {
      alert('Failed to explain script. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const handleImprove = async () => {
    if (!code.trim()) return

    const goal = prompt('What would you like to improve?', 'make it more efficient')
    if (!goal) return

    setLoading(true)
    try {
      const improved = await improveScript(code, goal)
      setCode(improved)
    } catch (error) {
      alert('Failed to improve script. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const handleSave = () => {
    onSave(code)
    onClose()
  }

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle>
            AI Script Editor {elementName && `- ${elementName}`}
          </DialogTitle>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)} className="flex-1 flex flex-col">
          <TabsList>
            <TabsTrigger value="ai">
              <Sparkles className="w-4 h-4 mr-2" />
              AI Generate
            </TabsTrigger>
            <TabsTrigger value="editor">
              <Code className="w-4 h-4 mr-2" />
              Code Editor
            </TabsTrigger>
            <TabsTrigger value="explain">
              <MessageSquare className="w-4 h-4 mr-2" />
              Explain
            </TabsTrigger>
          </TabsList>

          <TabsContent value="ai" className="flex-1 flex flex-col gap-4">
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium mb-2 block">
                  Describe what you want the script to do:
                </label>
                <textarea
                  value={aiPrompt}
                  onChange={(e) => setAiPrompt(e.target.value)}
                  className="w-full p-3 border-2 border-gray-300 rounded resize-none focus:outline-none focus:border-blue-500"
                  rows={4}
                  placeholder="Example: When clicked, show a message asking for the user's name, then navigate to the next card"
                />
              </div>

              <Button 
                onClick={handleGenerate} 
                disabled={loading || !aiPrompt.trim()}
                className="w-full"
              >
                {loading ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-4 h-4 mr-2" />
                    Generate Script
                  </>
                )}
              </Button>

              {code && (
                <div className="mt-4">
                  <div className="text-sm font-medium mb-2">Generated Code Preview:</div>
                  <pre className="text-xs bg-gray-50 p-3 rounded border-2 border-gray-200 overflow-x-auto font-mono">
                    {code}
                  </pre>
                </div>
              )}
            </div>
          </TabsContent>

          <TabsContent value="editor" className="flex-1 flex flex-col gap-2">
            <textarea
              value={code}
              onChange={(e) => setCode(e.target.value)}
              className="flex-1 font-mono text-sm p-4 border-2 border-gray-300 rounded resize-none focus:outline-none focus:border-blue-500"
              placeholder="// Write or edit your script here"
              spellCheck={false}
            />

            <div className="flex gap-2">
              <Button variant="outline" onClick={handleExplain} disabled={loading || !code.trim()} size="sm">
                <MessageSquare className="w-4 h-4 mr-2" />
                Explain Code
              </Button>
              <Button variant="outline" onClick={handleImprove} disabled={loading || !code.trim()} size="sm">
                <Wand2 className="w-4 h-4 mr-2" />
                Improve
              </Button>
            </div>
          </TabsContent>

          <TabsContent value="explain" className="flex-1 overflow-y-auto">
            {loading ? (
              <div className="flex items-center justify-center h-full">
                <Loader2 className="w-8 h-8 animate-spin text-blue-500" />
              </div>
            ) : explanation ? (
              <div className="prose prose-sm max-w-none">
                <p>{explanation}</p>
              </div>
            ) : (
              <div className="text-center text-gray-500 py-8">
                Click "Explain Code" to understand what your script does
              </div>
            )}
          </TabsContent>
        </Tabs>

        <div className="flex justify-end gap-2 pt-4 border-t">
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={!code.trim()}>
            Save Script
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

### 5.5 AI Element Suggestions

**Element Suggestion Service**: `lib/ai/element-suggestions.ts`

```typescript
import { Element, Card } from '@/lib/types'

const SUGGESTION_SYSTEM_PROMPT = `You are an expert UX designer helping users create interactive HyperCard-style applications. 
Suggest improvements, missing elements, or better layouts based on the current card state.
Be specific and actionable. Focus on interactivity and user experience.`

export async function getSuggestionsForCard(
  card: Card,
  elements: Element[]
): Promise<string[]> {
  const cardDescription = `
Card name: ${card.name}
Number of elements: ${elements.length}
Element types: ${elements.map(e => e.type).join(', ')}
Background color: ${card.backgroundColor}
  `.trim()

  const response = await fetch('/api/ai/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: `Analyze this HyperCard and suggest 3-5 improvements or additions:\n\n${cardDescription}\n\nProvide suggestions as a numbered list.`,
      systemPrompt: SUGGESTION_SYSTEM_PROMPT,
      maxTokens: 256,
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to get suggestions')
  }

  const data = await response.json()
  const suggestions = data.completion
    .split('\n')
    .filter((line: string) => line.match(/^\d+\./))
    .map((line: string) => line.replace(/^\d+\.\s*/, '').trim())

  return suggestions
}

export async function generateElementFromDescription(
  description: string
): Promise<Partial<Element>> {
  const response = await fetch('/api/ai/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: `Generate a HyperCard element configuration from this description: "${description}"

Return ONLY a valid JSON object with this structure:
{
  "type": "button|text|input|image|shape",
  "properties": { /* element-specific properties */ }
}

Do not include any other text or formatting.`,
      systemPrompt: 'You are a JSON generator. Return only valid JSON without markdown formatting.',
      maxTokens: 256,
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to generate element')
  }

  const data = await response.json()
  
  try {
    // Clean up potential markdown formatting
    let jsonStr = data.completion.trim()
    jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?/g, '')
    
    return JSON.parse(jsonStr)
  } catch (error) {
    console.error('Failed to parse AI response:', data.completion)
    throw new Error('Failed to parse element configuration')
  }
}
```

### 5.6 AI Command Palette

**AI Command Palette**: `components/editor/AICommandPalette.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useEditor } from '@/lib/context/EditorContext'
import { Dialog, DialogContent } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { generateElementFromDescription } from '@/lib/ai/element-suggestions'
import { Sparkles, Loader2 } from 'lucide-react'

interface AICommandPaletteProps {
  open: boolean
  onClose: () => void
}

export default function AICommandPalette({ open, onClose }: AICommandPaletteProps) {
  const [input, setInput] = useState('')
  const [loading, setLoading] = useState(false)
  const { currentCard, addElement } = useEditor()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!input.trim() || !currentCard) return

    setLoading(true)
    try {
      const elementConfig = await generateElementFromDescription(input)
      
      // Create element with AI-generated config
      const newElement = {
        id: crypto.randomUUID(),
        cardId: currentCard.id,
        type: elementConfig.type!,
        orderIndex: 0,
        position: { x: 100, y: 100, width: 200, height: 100 },
        properties: elementConfig.properties || {},
        script: null,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      }

      addElement(newElement as any)
      setInput('')
      onClose()
    } catch (error) {
      console.error('Failed to create element:', error)
      alert('Failed to create element. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <form onSubmit={handleSubmit}>
          <div className="flex items-center gap-2">
            <Sparkles className="w-5 h-5 text-blue-500" />
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Describe what you want to create... (e.g., 'a blue button that says Start')"
              className="flex-1"
              autoFocus
              disabled={loading}
            />
            {loading && <Loader2 className="w-5 h-5 animate-spin text-blue-500" />}
          </div>
        </form>

        <div className="text-xs text-gray-500 mt-2">
          Press Enter to create • Esc to close
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

### 5.7 Integrate AI Features into Editor

**Update EditorToolbar.tsx** to include AI command:

```typescript
// Add AI command button
const [showAICommand, setShowAICommand] = useState(false)

// Add keyboard shortcut listener
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault()
      setShowAICommand(true)
    }
  }

  window.addEventListener('keydown', handleKeyDown)
  return () => window.removeEventListener('keydown', handleKeyDown)
}, [])

// Add button to toolbar
<Button
  variant="outline"
  size="sm"
  onClick={() => setShowAICommand(true)}
  className="border-2 border-black"
>
  <Sparkles className="w-4 h-4 mr-2" />
  AI Create (⌘K)
</Button>

// Add the command palette
<AICommandPalette
  open={showAICommand}
  onOpenChange={setShowAICommand}
/>
```

### 5.8 AI Smart Suggestions Panel

**Smart Suggestions**: `components/editor/SmartSuggestions.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useEditor } from '@/lib/context/EditorContext'
import { getSuggestionsForCard } from '@/lib/ai/element-suggestions'
import { Button } from '@/components/ui/button'
import { Lightbulb, RefreshCw, Loader2 } from 'lucide-react'

export default function SmartSuggestions() {
  const { currentCard, elements } = useEditor()
  const [suggestions, setSuggestions] = useState<string[]>([])
  const [loading, setLoading] = useState(false)

  const loadSuggestions = async () => {
    if (!currentCard) return

    setLoading(true)
    try {
      const newSuggestions = await getSuggestionsForCard(currentCard, elements)
      setSuggestions(newSuggestions)
    } catch (error) {
      console.error('Failed to load suggestions:', error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    if (currentCard && elements.length > 0) {
      loadSuggestions()
    }
  }, [currentCard?.id])

  if (!currentCard) return null

  return (
    <div className="p-4 border-t-2">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Lightbulb className="w-4 h-4 text-yellow-500" />
          <h4 className="font-semibold text-sm">Smart Suggestions</h4>
        </div>
        <Button
          size="sm"
          variant="ghost"
          onClick={loadSuggestions}
          disabled={loading}
        >
          {loading ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <RefreshCw className="w-4 h-4" />
          )}
        </Button>
      </div>

      {loading && suggestions.length === 0 ? (
        <div className="text-sm text-gray-500">Loading suggestions...</div>
      ) : suggestions.length > 0 ? (
        <ul className="space-y-2">
          {suggestions.map((suggestion, index) => (
            <li key={index} className="text-sm text-gray-700 flex items-start gap-2">
              <span className="text-blue-500 mt-0.5">•</span>
              <span>{suggestion}</span>
            </li>
          ))}
        </ul>
      ) : (
        <div className="text-sm text-gray-500">
          Add some elements to get AI suggestions
        </div>
      )}
    </div>
  )
}
```

**Add to PropertyPanel.tsx**:
```typescript
import SmartSuggestions from './SmartSuggestions'

// At the bottom of the property panel
<SmartSuggestions />
```

## Deliverables Checklist

- [ ] Anthropic API integration setup
- [ ] AI completion API route
- [ ] Script generation from natural language
- [ ] Script explanation feature
- [ ] Script improvement suggestions
- [ ] AI-powered script editor component
- [ ] Element generation from descriptions
- [ ] AI command palette (⌘K)
- [ ] Smart suggestions panel
- [ ] Error handling for API failures

## Testing Checklist

- [ ] Natural language generates valid scripts
- [ ] Script explanations are accurate and helpful
- [ ] Element generation creates usable elements
- [ ] AI command palette responds to keyboard shortcut
- [ ] Suggestions are relevant to current card
- [ ] Loading states display properly
- [ ] Error messages are user-friendly
- [ ] API rate limits are handled gracefully

## Next Phase
Proceed to `06-PHASE-6-PUBLISHING.md` for stack publishing and sharing features.